name: ğŸš€ Deploy AutomÃ¡tico para Firebase

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“‹ Instalar dependÃªncias
      run: |
        npm ci
        npm install -g firebase-tools

    - name: ğŸ” Detectar mudanÃ§as
      id: changes
      run: |
        echo "files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | tr '\n' ' ')" >> $GITHUB_OUTPUT
        echo "commit_message=${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT

    - name: ğŸ§ª Executar testes
      run: npm test
      continue-on-error: false

    - name: ğŸ—ï¸ Build do projeto
      run: npm run build

    - name: ğŸ”¥ Deploy para Firebase Hosting
      if: contains(steps.changes.outputs.files, 'public/') || contains(steps.changes.outputs.files, 'dist/')
      run: |
        echo "Fazendo deploy do Hosting..."
        firebase deploy --only hosting --project $FIREBASE_PROJECT_ID --token ${{ secrets.FIREBASE_TOKEN }}

    - name: âš¡ Deploy Cloud Functions
      if: contains(steps.changes.outputs.files, 'functions/')
      run: |
        echo "Fazendo deploy das Functions..."
        cd functions
        npm ci
        cd ..
        firebase deploy --only functions --project $FIREBASE_PROJECT_ID --token ${{ secrets.FIREBASE_TOKEN }}

    - name: ğŸ“Š Atualizar Firestore
      if: contains(steps.changes.outputs.files, 'firestore/') || contains(steps.changes.outputs.files, 'rules/')
      run: |
        echo "Atualizando regras do Firestore..."
        firebase deploy --only firestore --project $FIREBASE_PROJECT_ID --token ${{ secrets.FIREBASE_TOKEN }}

    - name: ğŸ”„ Atualizar Database
      if: contains(steps.changes.outputs.files, 'database/')
      run: |
        echo "Atualizando Realtime Database..."
        firebase deploy --only database --project $FIREBASE_PROJECT_ID --token ${{ secrets.FIREBASE_TOKEN }}

    - name: ğŸ“± Notificar sucesso
      if: success()
      run: |
        echo "âœ… Deploy realizado com sucesso!"
        echo "Commit: ${{ github.sha }}"
        echo "Mensagem: ${{ steps.changes.outputs.commit_message }}"
        echo "Arquivos alterados: ${{ steps.changes.outputs.files }}"

    - name: ğŸš¨ Notificar erro
      if: failure()
      run: |
        echo "âŒ Erro no deploy!"
        echo "Verificar logs para mais detalhes."

  cleanup:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ğŸ§¹ Limpeza de cache
      run: |
        echo "Limpando cache e recursos temporÃ¡rios..."
